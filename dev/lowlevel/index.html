<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Low-level building blocks · DynamicHMC.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link href="../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMC.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../">Overview</a></li><li><a class="toctext" href="../api/">High-level API</a></li><li class="current"><a class="toctext" href>Low-level building blocks</a><ul class="internal"><li class="toplevel"><a class="toctext" href="#Low-level-building-blocks-1">Low-level building blocks</a></li><li><a class="toctext" href="#Hamiltonian-and-leapfrog-1">Hamiltonian and leapfrog</a></li><li><a class="toctext" href="#Finding-initial-stepsize-\\epsilon-1">Finding initial stepsize <span>$\epsilon$</span></a></li><li><a class="toctext" href="#Dual-averaging-1">Dual averaging</a></li><li><a class="toctext" href="#Abstract-trajectory-interface-1">Abstract trajectory interface</a></li><li><a class="toctext" href="#Proposals-1">Proposals</a></li><li><a class="toctext" href="#Divergence-statistics-1">Divergence statistics</a></li><li><a class="toctext" href="#Turn-analysis-1">Turn analysis</a></li><li><a class="toctext" href="#Sampling-1">Sampling</a></li><li><a class="toctext" href="#Tuning-1">Tuning</a></li><li><a class="toctext" href="#diagnostics_lowlevel-1">Diagnostics</a></li><li><a class="toctext" href="#Reporting-information-during-runs-1">Reporting information during runs</a></li><li><a class="toctext" href="#Utilities-and-miscellanea-1">Utilities and miscellanea</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Low-level building blocks</a></li></ul><a class="edit-page" href="https://github.com/tpapp/DynamicHMC.jl/blob/master/docs/src/lowlevel.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Low-level building blocks</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Notation-1" href="#Notation-1">Notation</a></h1><p>Notation follows <a href="https://arxiv.org/abs/1701.02434">Betancourt (2017)</a>, with some differences.</p><p>Instead of energies, <em>negative</em> energies are used in the code.</p><p>The following are used consistently for variables:</p><ul><li><code>ℓ</code>: log density we sample from, supports the interface of <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.AbstractLogDensityProblem</a></li><li><code>κ</code>: distribution/density that corresponds to kinetic energy</li><li><code>H</code>: Hamiltonian</li><li><code>q</code>: position</li><li><code>p</code>: momentum</li><li><code>z</code>: point in phase space (q,p)</li><li><code>ϵ</code>: stepsize</li><li><code>a</code>: acceptance rate</li><li><code>A</code>: acceptance tuning state</li><li><code>ζ</code>: proposal from trajectory (phase point and weight)</li><li><code>τ</code>: turn statistic</li><li><code>d</code>: divergence statistic</li><li><code>π</code>: log density (<strong>different from papers</strong>)</li><li><code>Δ</code>: logdensity relative to initial point of trajectory</li></ul><h1><a class="nav-anchor" id="Low-level-building-blocks-1" href="#Low-level-building-blocks-1">Low-level building blocks</a></h1><p>This is documented only for developers. These are not part of the public API, if you are using them you should reconsider or file an issue.</p><h2><a class="nav-anchor" id="Hamiltonian-and-leapfrog-1" href="#Hamiltonian-and-leapfrog-1">Hamiltonian and leapfrog</a></h2><pre><code class="language-none">Hamiltonian
PhasePoint
phasepoint_in
rand_phasepoint
neg_energy
get_p♯
loggradient
leapfrog</code></pre><h2><a class="nav-anchor" id="Finding-initial-stepsize-\\epsilon-1" href="#Finding-initial-stepsize-\\epsilon-1">Finding initial stepsize <span>$\epsilon$</span></a></h2><p>Local stepsize tuning.</p><p>The local acceptance ratio is technically a probability, but for finding the initial stepsize, it is not capped at <span>$1$</span>.</p><p>Also, the values are cached as this is assumed to be moderately expensive to calculate.</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DynamicHMC.find_initial_stepsize" href="#DynamicHMC.find_initial_stepsize"><code>DynamicHMC.find_initial_stepsize</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">find_initial_stepsize(parameters, A)
</code></pre><p>Find an initial stepsize that matches the conditions of <code>parameters</code> (see <a href="#DynamicHMC.InitialStepsizeSearch"><code>InitialStepsizeSearch</code></a>).</p><p><code>A</code> is the local acceptance ratio (uncapped). When given a Hamiltonian <code>H</code> and a phasepoint <code>z</code>, it will be calculated using <a href="#DynamicHMC.local_acceptance_ratio"><code>local_acceptance_ratio</code></a>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/tpapp/DynamicHMC.jl/blob/60a6f891aa0a8666f4323368fec43a4070f22531/src/stepsize.jl#L128">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DynamicHMC.InitialStepsizeSearch" href="#DynamicHMC.InitialStepsizeSearch"><code>DynamicHMC.InitialStepsizeSearch</code></a> — <span class="docstring-category">Type</span>.</div><div><div><pre><code class="language-julia">struct InitialStepsizeSearch</code></pre><p>Parameters for the search algorithm for the initial stepsize.</p><p>The algorithm finds an initial stepsize <span>$ϵ$</span> so that the local acceptance ratio <span>$A(ϵ)$</span> satisfies</p><div>\[a_\text{min} ≤ A(ϵ) ≤ a_\text{max}\]</div><p>This is achieved by an initial bracketing, then bisection.</p><ul><li><p><code>a_min</code></p><p>Lowest local acceptance rate.</p></li><li><p><code>a_max</code></p><p>Highest local acceptance rate.</p></li><li><p><code>ϵ₀</code></p><p>Initial stepsize.</p></li><li><p><code>C</code></p><p>Scale factor for initial bracketing, &gt; 1. <em>Default</em>: <code>2.0</code>.</p></li><li><p><code>maxiter_crossing</code></p><p>Maximum number of iterations for initial bracketing.</p></li><li><p><code>maxiter_bisect</code></p><p>Maximum number of iterations for bisection.</p></li></ul><div class="admonition note"><div class="admonition-title">Note</div><div class="admonition-text"><p>Cf. Hoffman and Gelman (2014), which does not ensure bounds for the acceptance ratio, just that it has crossed a threshold. This version seems to work better for some tricky posteriors with high curvature.</p></div></div></div></div><a class="source-link" target="_blank" href="https://github.com/tpapp/DynamicHMC.jl/blob/60a6f891aa0a8666f4323368fec43a4070f22531/src/stepsize.jl#L9">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DynamicHMC.find_crossing_stepsize" href="#DynamicHMC.find_crossing_stepsize"><code>DynamicHMC.find_crossing_stepsize</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">find_crossing_stepsize(parameters, A, ϵ₀)
find_crossing_stepsize(parameters, A, ϵ₀, Aϵ₀)
</code></pre><p>Find the stepsize for which the local acceptance rate <code>A(ϵ)</code> crosses <code>a</code>.</p><p>Return <code>ϵ₀, A(ϵ₀), ϵ₁</code>, A(ϵ₁)<code>, where</code>ϵ₀<code>and</code>ϵ₁<code>are stepsizes before and after crossing</code>a<code>with</code>A(ϵ)`, respectively.</p><p>Assumes that <span>$A(ϵ₀) ∉ (a_\text{min}, a_\text{max})$</span>, where the latter are defined in <code>parameters</code>.</p><ul><li><p><code>parameters</code>: parameters for the iteration.</p></li><li><p><code>A</code>: local acceptance ratio (uncapped), a function of stepsize <code>ϵ</code></p></li><li><p><code>ϵ₀</code>, <code>Aϵ₀</code>: initial value of <code>ϵ</code>, and <code>A(ϵ₀)</code></p></li></ul></div></div><a class="source-link" target="_blank" href="https://github.com/tpapp/DynamicHMC.jl/blob/60a6f891aa0a8666f4323368fec43a4070f22531/src/stepsize.jl#L55">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DynamicHMC.bisect_stepsize" href="#DynamicHMC.bisect_stepsize"><code>DynamicHMC.bisect_stepsize</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">bisect_stepsize(parameters, A, ϵ₀, ϵ₁)
bisect_stepsize(parameters, A, ϵ₀, ϵ₁, Aϵ₀)
bisect_stepsize(parameters, A, ϵ₀, ϵ₁, Aϵ₀, Aϵ₁)
</code></pre><p>Return the desired stepsize <code>ϵ</code> by bisection.</p><ul><li><p><code>parameters</code>: algorithm parameters, see <a href="#DynamicHMC.InitialStepsizeSearch"><code>InitialStepsizeSearch</code></a></p></li><li><p><code>A</code>: local acceptance ratio (uncapped), a function of stepsize <code>ϵ</code></p></li><li><p><code>ϵ₀</code>, <code>ϵ₁</code>, <code>Aϵ₀</code>, <code>Aϵ₁</code>: stepsizes and acceptance rates (latter optional).</p></li></ul><p>This function assumes that <span>$ϵ₀ &lt; ϵ₁$</span>, the stepsize is not yet acceptable, and the cached <code>A</code> values have the correct ordering.</p></div></div><a class="source-link" target="_blank" href="https://github.com/tpapp/DynamicHMC.jl/blob/60a6f891aa0a8666f4323368fec43a4070f22531/src/stepsize.jl#L93">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DynamicHMC.local_acceptance_ratio" href="#DynamicHMC.local_acceptance_ratio"><code>DynamicHMC.local_acceptance_ratio</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">local_acceptance_ratio(H, z)
</code></pre><p>Return a function of the stepsize (<span>$ϵ$</span>) that calculates the local acceptance ratio for a single leapfrog step around <code>z</code> along the Hamiltonian <code>H</code>. Formally, let</p><pre><code class="language-julia">A(ϵ) = exp(logdensity(H, leapfrog(H, z, ϵ)) - logdensity(H, z))</code></pre><p>Note that the ratio is not capped by <code>1</code>, so it is not a valid probability <em>per se</em>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/tpapp/DynamicHMC.jl/blob/60a6f891aa0a8666f4323368fec43a4070f22531/src/stepsize.jl#L165">source</a></section><h2><a class="nav-anchor" id="Dual-averaging-1" href="#Dual-averaging-1">Dual averaging</a></h2><pre><code class="language-none">DualAveragingParameters
DualAveragingAdaptation
get_ϵ
adapting_ϵ
adapt_stepsize</code></pre><h2><a class="nav-anchor" id="Abstract-trajectory-interface-1" href="#Abstract-trajectory-interface-1">Abstract trajectory interface</a></h2><p>In contrast to other reference implementations, the algorithm is implemented in a functional style using immutable values. The intention is to provide more transparency and facilitate fine-grained unit testing.</p><pre><code class="language-none">adjacent_tree
Termination
sample_trajectory</code></pre><h2><a class="nav-anchor" id="Proposals-1" href="#Proposals-1">Proposals</a></h2><pre><code class="language-none">Proposal
combined_logprob_logweight
combine_proposals</code></pre><h2><a class="nav-anchor" id="Divergence-statistics-1" href="#Divergence-statistics-1">Divergence statistics</a></h2><pre><code class="language-none">DivergenceStatistic
divergence_statistic
isdivergent
combine_divstats</code></pre><h2><a class="nav-anchor" id="Turn-analysis-1" href="#Turn-analysis-1">Turn analysis</a></h2><pre><code class="language-none">TurnStatistic
combine_turnstats
isturning</code></pre><h2><a class="nav-anchor" id="Sampling-1" href="#Sampling-1">Sampling</a></h2><pre><code class="language-none">Trajectory
leaf
move
NUTS_transition</code></pre><h2><a class="nav-anchor" id="Tuning-1" href="#Tuning-1">Tuning</a></h2><pre><code class="language-none">DynamicHMC.AbstractTuner</code></pre><h2><a class="nav-anchor" id="diagnostics_lowlevel-1" href="#diagnostics_lowlevel-1">Diagnostics</a></h2><pre><code class="language-none">NUTS_Statistics
ACCEPTANCE_QUANTILES
explore_local_acceptance_ratios</code></pre><h2><a class="nav-anchor" id="Reporting-information-during-runs-1" href="#Reporting-information-during-runs-1">Reporting information during runs</a></h2><p>Samplers take an <a href="@ref"><code>AbstractReport</code></a> argument, which is then used for reporting. The interface is as follows.</p><pre><code class="language-none">DynamicHMC.AbstractReport
DynamicHMC.report!
DynamicHMC.start_progress!
DynamicHMC.end_progress!</code></pre><p>The default is</p><pre><code class="language-none">ReportIO</code></pre><p>Reporting information can be suppressed with</p><pre><code class="language-none">ReportSilent</code></pre><p>Other interfaces should define similar types.</p><h2><a class="nav-anchor" id="Utilities-and-miscellanea-1" href="#Utilities-and-miscellanea-1">Utilities and miscellanea</a></h2><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DynamicHMC.rand_bool" href="#DynamicHMC.rand_bool"><code>DynamicHMC.rand_bool</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">rand_bool(rng, prob)
</code></pre><p>Random boolean which is <code>true</code> with the given probability <code>prob</code>.</p></div></div><a class="source-link" target="_blank" href="https://github.com/tpapp/DynamicHMC.jl/blob/60a6f891aa0a8666f4323368fec43a4070f22531/src/NUTS.jl#L35">source</a></section><footer><hr/><a class="previous" href="../api/"><span class="direction">Previous</span><span class="title">High-level API</span></a></footer></article></body></html>
